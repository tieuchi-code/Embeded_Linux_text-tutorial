In this instruction, we will learn how to write a simple driver module for BBB -> Hello kernel to print log that kernel is loaded or exited
Driver will create entry (/dev/gpiochip0, /dev/i2c-1 ....)
-> application will use driver to control LED

cd tisdk -> board support -> ti-kernel -> drivers
---------------------------------------------------------------
To write driver for kernel
cd ti-sdk -> boardsupport -> ti-kernel -> include -> linux -> init.h

search for "linux/init.h"
-> the file have funtion use for init
---------------------------------------------------------------

Create new project "Hello kernel"

create Hello_kernel.c

#include <linux/init.h>
#include <linux/module.h>
#include <linux/kernel.h>

static int __init hello_init(void)
{
    printk("[HELLO KERNEL DRIVER]: module loaded\n");
    return 0;
}

static void __exit hello_exit(void)
{
    printk("[HELLO KERNEL]: module exited\n");
}

MODULE_LICENSE("GPL");
MODULE_AUTHOR("Tieu Chi");
MODULE_DESCRIPTION("Hello kernel demo");
module_init(hello_init);
module_exit(hello_exit);
---------------------------------------------------------------

Makefile

obj-m := Hello_kernel.o 
KERNELDIR=/home/tieuchi/ti-processor-sdk-linux-am335x-evm-09.03.05.02/board-support/ti-linux-kernel-6.1.119+gitAUTOINC+c490f4c0fe-ti
CURRENTDIR=$(shell pwd)
CROSS=/home/tieuchi/ti-processor-sdk-linux-am335x-evm-09.03.05.02/external-toolchain-dir/arm-gnu-toolchain-11.3.rel1-x86_64-arm-none-linux-gnueabihf/bin/arm-none-linux-gnueabihf-

all:
	$(MAKE) -C $(KERNELDIR) M=$(CURRENTDIR) ARCH=arm CROSS_COMPILE=$(CROSS) modules
clean:
	$(MAKE) -C $(KERNELDIR) M=$(CURRENTDIR) ARCH=arm CROSS_COMPILE=$(CROSS) clean
-----------------------------------------------------------------------------------
OK, now 2 file is done
to build Hello_kernel.ko

Host:

->make
->scp Hello_kernel.ko root@192.168.8.8:/home/root

BBB:

insmod Hello_kernel.ko
dmesg

you will see the log
[HELLO KERNEL DRIVER]: this module is loaded
-------------------------------------------------------------

to remove module
BBB:

rmmod Hello_kernel.ko
dmesg

you will see
[HELLO KERNEL]:module exited
---------------------------------------------------------

Fix magic version error

root@am335x-evm:~# insmod hello-kernel.ko                                                                             
[   93.497405] hello_kernel: version magic '6.1.119 preempt mod_unload ARMv7 p2v8 ' should be '6.1.119-ti-gc490f4c0fe'
insmod: ERROR: could not insert module hello-kernel.ko: Invalid module format        

this error happen because you are using a different version of zImage, you have to you zImage you built (zImage), not the one TI-SDK give (zImage-am335x-evm)
To fix this, you have to build zImage and boot again it to BBB, follow step below

1.Check
ti-sdk -> boardsupport -> built-image
if you see zImage -> OK
(or you can check in root/tftpboot)
if no zImage
	-> cd ti-sdk 
	-> make linux
	-> make linux_install
check in built-image again, there is zIamge file

check where is tftp server, often in root directory
-> cd / -> ls
tieuchi@tieuchi:/$ ls
bin   cdrom  etc   lib    lib64   lost+found  mnt  proc  run   snap  sys       tmp  var
boot  dev    home  lib32  libx32  media       opt  root  sbin  srv   tftpboot  usr

copy zImage to tftpboot

-> cd ti-sdk -> boardsupport -> built-image
-> cp zImage /tftpboot/

Check again in tftpboot, there is zImage file

Now we have to fix setupBoard.com to boot zImage

->sudo vim setupBoard.minicom

send "setenv bootfile zImage"
send setenv bootcmd 'run findfdt; run init_console; setenv autoload no;tftp ${loadaddr} zImage; tftp ${fdtaddr} ${fdtfile}; bootz ${loadaddr} - ${fdtaddr}'

OK, now boot image again

ok, now insmod again
root@am335x-evm:~# insmod hello-kernel.ko                                                                             
[  127.969741] hello_kernel: loading out-of-tree module taints kernel.                                                
[  127.976554] [HELLO KERNEL DRIVER]: this module loaded     
-----------------------------------------------------------------------------

When you copy hello-kernel.ko to BBB, if it appear this error

Add correct host key to home/tieuchi/.shh/known_host

it require a hostkey, you remove the file, it's ok

rm home/tieuchi/.shh/known_host
--------------------------------------------------------------------------
===============================================================================================

Now we have to create sys/class/hello-kernel

#include <linux/device.h>

in file device.h has class.h
class.h provide a struct to create class









